---
title: "Le format de donn√©es `Parquet`"
subtitle: |
  Une d√©couverte √† travers l'exemple des donn√©es du recensement
author:
    - Lino Galiana
description: "Slides pr√©sentant les enjeux de l'utilisation du format `Parquet` et l'√©cosyst√®me associ√©"
date: "2024-11-05"
date-format: long
slide-number: true
footer: |
  Atelier [`tuto@mate`](https://mate-shs.cnrs.fr/actions/tutomate/tuto62_parquet_galiana/) ([retour √† la page principale de ce site](/index.qmd))
lang: fr-FR
chalkboard: # press the B key to toggle chalkboard
  theme: whiteboard
format:
  onyxia-revealjs:
    output-file: index.html
    output-dir: _site
controls: true
css: custom.css
from: markdown+emoji
image: "/img/librairies2.png"
priority: 1
---

# Introduction

## Plan

1. Contexte
2. Pourquoi le format `Parquet` ?
3. L'√©cosyst√®me `Parquet`
4. D√©monstration

# Contexte sur le recensement de la population 

## Le recensement de la population {.smaller}

* [__Mission historique__]{.orange} de l'Insee depuis 1946
    + L'Insee organise, les communes r√©alisent la collecte

. . .


* Une source d'__[utilit√© publique](https://www.le-recensement-et-moi.fr/cest-utile/)__ :
    + Populations l√©gales: dotations de l'√âtat aux communes, organisation des scrutins, √©quipements publics, etc.
    + Recherche: caract√©ristiques socio-d√©mographiques, mobilit√©s...


::: {.callout-note}
## Enqu√™tes annuelles de recensement (EAR) depuis 2004

* Pour une commune de __[moins de 10 000 habitants]{.blue2}__:
    + Collecte exhaustive une fois tous les 5 ans.
* Pour une commune de __[plus de 10 000 habitants]{.blue2}__:
    + Chaque ann√©e, 8% des logements sont recens√©s ;
    + Le r√©sultat du recensement est calcul√© √† partir des 5 derni√®res ann√©es (=40% logements)

_[Documentation technique sur le recensement](https://www.insee.fr/fr/information/2383410)_

:::


## Une diffusion sous plusieurs formes

* Diffusion sur [insee.fr](https://www.insee.fr/fr/information/7619431) sous plusieurs formes:
  * Pages _"dynamiques"_ sur [insee.fr](https://www.insee.fr/fr/information/7619431)
  * Exports d'agr√©gats depuis [statistiques-locales.insee.fr/](https://statistiques-locales.insee.fr/)
  * Des donn√©es, des cartes, des publications, etc..

. . .

* Mais [**beaucoup de gestes manuels**]{.orange} pour obtenir un seul agr√©gat

. . .

* Une [**information parfois difficile √† trouver**]{.orange} sur le site de l'Insee


## Une diffusion sous plusieurs formes

<h3>Les fichiers agr√©g√©s</h3>
<br>

- Structure type: une ligne [**par commune ou IRIS**]{.orange}

. . .

- Taille de chaque fichier relativement raisonnable
  - CSV g√©n√©ralement de quelques Mo, jusqu'√† **150** Mo
  
![](https://git.lab.sspcloud.fr/ssplab/parquet_insee_contact/-/raw/master/img/telechargement_inseefr.png?ref_type=heads){fig-align="center"}


## Une diffusion sous plusieurs formes

<h3>Les micro-donn√©es anonymis√©es</h3>

- Structure type: une ligne [**par observation**]{.orange}
    + Un logement, un individu...

. . .

- Permet de construire d'autres croisements que ceux propos√©s sur [insee.fr](https://www.insee.fr/fr/accueil)

. . .

::: {.callout-warning}
# Un format destin√© √† des [**utilisateurs avanc√©s**]{.blue2}

- Une source riche mais des [__pr√©cautions d'emploi__]{.orange} √† respecter:
  - Pond√©rations √† prendre en compte
  - Interpr√©tation des petits effectifs...
- Demande une certaine expertise
:::

## D√©fi

- Ce sont des fichiers [__tr√®s volumineux__]{.orange}
  - Jusqu'√† 100 variables et [__25 millions__]{.blue2} de lignes
  - Fichier CSV [**jusqu'√† 5 Go**]{.blue2}

. . .

- **Pour l'Insee :** complexes √† produire et valider avant diffusion 

. . .

- **Pour l'utilisateur.trice :** complexes √† t√©l√©charger, stocker et exploiter

## Solution historique

- __[Diffusion zipp√©e (CSV)]{.orange}__ ou format DBase (format propri√©taire)
    + D√©coupage en fichiers par grandes zones de r√©gions

![](https://git.lab.sspcloud.fr/ssplab/parquet_insee_contact/-/raw/master/img/decoupage_csv.png?ref_type=heads){fig-align="center"}


## Une source id√©ale pour innover dans la diffusion {transition="slide" transition-speed="slow"}

- Mont√©e en puissance du format `Parquet` pour les usages internes √† l'Insee:
    + Pourquoi ne pas offrir le m√™me confort √† l'externe ? 

. . .

- Une demande d'utilisateurs.trices averti.e.s
    + Par exemple [Eric Mauvi√®re](https://www.icem7.fr/cartographie/parquet-devrait-remplacer-le-format-csv/)


## Une source id√©ale pour innover dans la diffusion {transition="slide" transition-speed="slow"}


- Publication en octobre 2023 des donn√©es et d'[un guide d'utilisation](https://ssphub.netlify.app/post/parquetrp/)



![](https://ssphub.netlify.app/post/parquetRP/ducks.png){fig-align="center"}


## Une source id√©ale pour innover dans la diffusion {transition="fade" transition-speed="fast"}

- Un accueil enthousiaste des utilisateurs.trices

:::: {.columns}

::: {.column width="50%"}
![](https://git.lab.sspcloud.fr/ssplab/parquet_insee_contact/-/raw/master/img/retour_utilisateur_1.png){width=700px}
:::

::: {.column width="50%"}
![](https://git.lab.sspcloud.fr/ssplab/parquet_insee_contact/-/raw/master/img/retour_utilisateur_2.png){width=700px}
:::

::::

:::: {.columns}

::: {.column width="50%"}
![](https://git.lab.sspcloud.fr/ssplab/parquet_insee_contact/-/raw/master/img/img3.png){width=700px}
:::

::: {.column width="50%"}
![](https://git.lab.sspcloud.fr/ssplab/parquet_insee_contact/-/raw/master/img/img4.png){width=700px}
:::

::::

## Une source id√©ale pour innover dans la diffusion {transition="fade" transition-speed="fast"}

- D'autres institutions l'utilisent maintenant pour leur diffusion

:::: {.columns}

::: {.column width="50%"}
![](https://raw.githubusercontent.com/linogaliana/prez-parquet-ocde-2024/main/img/loquet.png)
:::

::: {.column width="50%"}
[Statistiques sur longue p√©riode des crimes et d√©lis](https://www.linkedin.com/feed/update/urn:li:activity:7163227953928089601/)
:::

::::

# Pourquoi le format `Parquet` ?

## Parquet : c'est quoi ?

- Un [**format de donn√©es**]{.orange} adapt√©...
    - Aux donn√©es volumineuses ;
    - Aux donn√©es complexes (exemple: <b><ins>01</ins>004</b> pour le code commune d'Amb√©rieu-en-Bugey)

. . .

- Un format de donn√©es _opensource_ bien int√©gr√©:
    - A l'√©cosyst√®me `R`, `Python` et `Observable`


## Parquet : pourquoi ?

- Format l√©ger, [**tr√®s compress√©**]{.orange}:
    - Entre 5 et 20 fois plus l√©ger qu'un CSV
    - Pas de perte d'efficacit√© en lecture


:::: {.columns}

::: {.column width="50%"}

::::: {.callout-note}
## Exemple: recensement de la population

- 20 millions de lignes, 88 colonnes
    - CSV: > 5Go
    - Parquet: 508Mo

:::::

:::

::: {.column width="50%"}

::::: {.callout-note}
## Exemple: statistiques de la d√©linquance

- 3.5 millions de lignes: 
    - CSV: 400Mo
    - Parquet: 11Mo

:::::


:::


::::

## Le `CSV`: en apparence pratique

:::: {.columns}

::: {.column width="60%"}

<br><br>

- Facile √† lire, facile √† ouvrir, __mais__

:::

::: {.column width="30%"}
![](/img/parquet-table1.png)
:::

::::

:::::: {.callout-caution}
## Probl√®me: il faut scanner tout le fichier pour avoir une seule colonne

- Lent en lecture, pas compress√©
- Probl√®me pour deviner le type d'une variable
- M√™me si on ne veut que certaines colonnes, il faut lire tout le fichier
::::::


## `Parquet`: un format orient√© colonne

![](/img/parquet-table2-enriched.png){fig-align="center"}

- Plus pratique pour n'ouvrir qu'un sous-ensemble de variables ;
    + Pas besoin de scanner tout le fichier pour √©tudier quelques variables ;


## `Parquet` : quels avantages ?
<br>


- Format libre, _open source_, et ind√©pendant du langage ;

. . .

- [__Plus de confort__]{.orange} pour les utilisateurs:
    + Des requ√™tes plus rapides et efficaces (seulement les donn√©es n√©cessaires sont lues)
    + Des donn√©es conformes √† la mise √† disposition par le producteur (plus de probl√®me de codes communes...)


## `Parquet` : quels usages ?

- Format privil√©gi√© pour la mise √† disposition de donn√©es internes √† l'Insee:
    + Moins d'asym√©tries entre utilisateurs et producteurs.

::: {.callout-note}
## Premi√®res diffusions √† l'externe

- Bureaux de votes du __[r√©pertoire √©lectoral unique (REU)]{.blue2}__:
- [**Recensement de la population (RP)**]{.blue2} 
- Plus r√©cemment, la [__[base permanente des √©quipements (BPE)](https://www.insee.fr/fr/statistiques/8217525?sommaire=8217537)__]{.blue2}

:::

## `Parquet` : quels usages ?


```{ojs}
viewof source = Inputs.radio([
  "Recensement", "R√©pertoire √©lectoral unique"
], {value: "Recensement"})
```

<br>

```{ojs}
Inputs.table(data)
```

```{ojs}
data = (source == "Recensement") ? rp : reu
```

```{ojs}
db = DuckDBClient.of({})

rp = db.query(
  "SELECT AGED, CATL, SEXE, CANTVILLE, IPONDI FROM read_parquet('https://static.data.gouv.fr/resources/recensement-de-la-population-fichiers-detail-individus-localises-au-canton-ou-ville-2020-1/20231023-122841/fd-indcvi-2020.parquet') LIMIT 5"
)
reu = db.query(
  "SELECT geo_adresse, id_brut_bv_reu FROM read_parquet('https://static.data.gouv.fr/resources/bureaux-de-vote-et-adresses-de-leurs-electeurs/20230626-135723/table-adresses-reu.parquet') LIMIT 5"
)
```

## Pourquoi `DuckDB` ?

* `Parquet` ne r√©sout pas tout:
  + L‚Äôespace disque est optimis√©
  + Les donn√©es d√©compress√©es doivent passer en RAM


‚ùìÔ∏è _Comment analyser ces donn√©es sur un PC avec 8 GB de RAM ?_

## Pourquoi `DuckDB` ?

![](/img/librairies2.png){fig-align="center"}


## Pourquoi `DuckDB` ? {.smaller}

:::: {.columns}

::: {.column width="83%"}

* `DuckDB` est un utilitaire _open source_
    + Un logiciel en ligne de commande tout simple (20Mo)...
    + Des librairies {{< fa brands r-project >}}, {{< fa brands python >}} et `Observable` pour simplifier l'usage
    + Requ√™tes SQL mais aussi int√©gration `tidyverse` pour {{< fa brands r-project >}}

:::

::: {.column width="2%"}
:::


::: {.column width="15%"}

![](https://upload.wikimedia.org/wikipedia/commons/thumb/4/40/DuckDB_logo.svg/1200px-DuckDB_logo.svg.png)

:::

::::

. . .

* `DuckDB` est tr√®s efficace:
    + Moteur SQL enrichi avec des fonctions tr√®s pratiques pour l'analyse
    + Optimisations automatiques
    + Visualisations sans ex√©cuter sur toute la base

. . .

üí° Les __[avantages du monde des bases de donn√©es sans ses inconv√©nients]{.orange}__

# D√©monstrations

## Reproductibilit√© des exemples {.smaller}

:::: {.columns}

::: {.column width="60%"}

* Plateforme de _data science_ d√©velopp√©e par l'Insee
    + Environnements standardis√©s {{< fa brands r-project >}}, {{< fa brands python >}}
    + Accessible aux chercheurs.euses pour l'enseignement üòâ

<br>

* Environnements pr√©configur√©s lan√ßables en 1 clic:

```{=html}
<a href="https://github.com/linogaliana/parquet-recensement-tutomate" target="_blank" rel="noopener" data-original-href="https://github.com/linogaliana/parquet-recensement-tutomate"><img src="https://img.shields.io/static/v1?logo=github&amp;label=&amp;message=View%20on%20GitHub&amp;color=181717" alt="View on GitHub"></a>
<a href="https://datalab.sspcloud.fr/launcher/ide/vscode-python?name=atelier-tutomate&version=2.1.14&autoLaunch=true&init.personalInit=¬´https%3A%2F%2Fraw.githubusercontent.com%2Flinogaliana%2Fparquet-recensement-tutomate%2Frefs%2Fheads%2Fmain%2Fsspcloud%2Finit-python.sh¬ª" target="_blank" rel="noopener" data-original-href="https://datalab.sspcloud.fr/launcher/ide/vscode-python?name=atelier-tutomate&version=2.1.14&autoLaunch=true&init.personalInit=¬´https%3A%2F%2Fraw.githubusercontent.com%2Flinogaliana%2Fparquet-recensement-tutomate%2Frefs%2Fheads%2Fmain%2Fsspcloud%2Finit-python.sh¬ª"><img src="https://img.shields.io/badge/SSP%20Cloud-Lancer_avec_VSCode-blue?logo=visualstudiocode&amp;logoColor=blue" alt="Onyxia"></a>
<a href="https://datalab.sspcloud.fr/launcher/ide/rstudio?name=atelier-tutomate-r&version=2.1.10&autoLaunch=true&init.personalInit=¬´https%3A%2F%2Fraw.githubusercontent.com%2Flinogaliana%2Fparquet-recensement-tutomate%2Frefs%2Fheads%2Fmain%2Fsspcloud%2Finit-r.sh¬ª&networking.user.enabled=true" target="_blank" rel="noopener" data-original-href="https://datalab.sspcloud.fr/launcher/ide/rstudio?name=atelier-tutomate-r&version=2.1.10&autoLaunch=true&init.personalInit=¬´https%3A%2F%2Fraw.githubusercontent.com%2Flinogaliana%2Fparquet-recensement-tutomate%2Frefs%2Fheads%2Fmain%2Fsspcloud%2Finit-r.sh¬ª&networking.user.enabled=true"><img src="https://img.shields.io/badge/SSP%20Cloud-Lancer_avec_R-blue?logo=rstudioide&amp;logoColor=blue" alt="Onyxia"></a>
```





:::

::: {.column width="40%"}

[![](https://raw.githubusercontent.com/linogaliana/draft-slides-pydata/master/onyxia-qrcode4.png){width=100%}](https://www.sspcloud.fr/formation)

:::

::::

::: {.callout-tip}

Si vous avez un [compte](https://datalab.sspcloud.fr/home), n'h√©sitez pas √† essayer les exemples pr√©sent√©s en _live_ !

:::



